#HBase的表设计

HBase典型的列存储型数据库。其列存储体现在同一个Column Family下的数据存储在相通的HFile中。HBase中没有主键的概念，其定位数据是通过RowKey定位的。对于具体的列，HBase支持自由扩展，非常松散。因此，HBase的表设计，其核心问题是RowKey和Column Family的设计。


## RowKey设计


RowKey是不可分割的字节数，按字典排序由低到高存储在表中。设计HBase的表时，RowKey设计最为重要，应该基于访问模式为RowKey建模。RowKey的设计决定了HBase表访问时的性能。

### RowKey设计原则

RowKey最好时String类型，一是方便线上使用shell查数据、排查错误；二是更容易让数据均匀分布；三是不必考虑存储成本。
 
##### 1. RowKey是以字典顺序从小到大排序。

##### 2. RowKey尽量散列

这条最为重要，RowKey散列，保证所有的数据不是在Region上，从而避免读写时负载集中在个别的Region中。关于如何散列RowKey，通常有以下三种方案：

 + 反转。对RowKey的字符串进行反转，反转后存储
 + 散列。散列RowKey，构造散列算法，对RowKey字符串散列之后在存储。
 + 前缀。对关键内容进行MD5，取前几位作为RowKey前缀。
 
#### 3. RowKey的长度尽量短
 
 如果RowKey太长，第一存储的开销会增加，影响存储效率；第二内存中的RowKey字段过长，会导致内存的利用率低，进而降低索引的命中率。
 
 一般做法是：
 
  + 时间使用Long类型
  + 尽量使用编码压缩



## Column Family设计

Column Family是一些列的集合。一个列族的所有成员有着相同的前缀。比如，列courses:history和courses:math都是列族的courses的成员。冒号（:）是列族的分隔符，用来区分前缀与列名。列族的前缀必须是可输出的字符，剩下的部分称为列（Qualifier），可由任意字节数组组成。列族必须在表建立的时候声明。列则不需要特别声明，用户随时可以创建新列。

在物理上，一个列族的成员在文件系统上都存储在一起，因为存储优化都是针对列族级别的，这就意味着，访问一个列族的所有成员的方式都是相同的。

目前，HBase并不能很好的存储两个或者三个以上的列族，所以尽量减少列族数量。目前，flush和compaction操作是针对一个Region的，所以当一个列族操作大量数据的时候会引发一个flush。那些不相关的列族也要进行flush操作。尽管它们没有操作多少数据。compaction操作现在是根据一个列族下的全部文件的数量出发的，而不是根据文件大小出发的。当很多的列族在进行flush和compaction时，会造成很多没用的I/O负载，要解决这个问题，需要将flush和cmpaction操作只针对一个列族进行。

尽量在应用中使用一个列族。如果所有的查询操作只访问一个列族，可以引入第二个和第三个列族。基于flush性能的考虑，列族数量越少越好。

如果一个表存储很多个列族，当基数差距很大时，例如，A列族友100万行，B列族有10亿行，A族可能会被分散到很多Region，导致扫描A的效率降低。多个列族在执行compaction时，会造成很多I/O负载。